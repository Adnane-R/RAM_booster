#!/bin/bash
#Written On: Dec 2014
#Written By: Tal
#Written For: Ubuntu Forums Community
#Description:
#	This script mounts the encrypted home directory of a user

#Only run if user is root
uid=$(/usr/bin/id -u) && [ "$uid" = "0" ] || 
{
        echo "You must be root to run $0."
        exit 1
}

#Check number of arguments
if [[ $# != 1 ]]
then
	echo "$0 takes exactly one argument - a username"
	exit 1
fi

#########################
# Ask for user password #
#########################

CRYPT_USER=$1

#Check if user exists
if ! grep -q "${CRYPT_USER}:" /etc/passwd
then
	echo "${CRYPT_USER} was not found"
	exit 1
fi

#Check if user's home dir is encrypted
if [[ ! -e /home/${CRYPT_USER}/.ecryptfs ]]
then
	echo "${CRYPT_USER} does not appear to be using an encrypted home dir"
	exit 1
fi

#Check if user's home dir is already mounted
if mountpoint -q /home/${CRYPT_USER}
then
	echo "/home/${CRYPT_USER} appears to already be mounted"
	exit 1
fi

#If user hits ctrl+c, enable echo of typed characters again
trap 'stty echo; echo; exit 1' SIGINT

echo -n "${CRYPT_USER} login password: "

#Disable echo of typed characters
stty -echo

read loginpass
echo
echo

#Enable echo of typed characters
stty echo

##################################
# Decrypt ${CRYPT_USER} home dir #
##################################

sig1=$(head -1 /home/.ecryptfs/${CRYPT_USER}/.ecryptfs/Private.sig 2>/dev/null)
sig2=$(tail -1 /home/.ecryptfs/${CRYPT_USER}/.ecryptfs/Private.sig 2>/dev/null)

printf '%s\0' "$loginpass" | ecryptfs-insert-wrapped-passphrase-into-keyring "/home/.ecryptfs/${CRYPT_USER}/.ecryptfs/wrapped-passphrase" - &>/dev/null

if [[ "$?" != 0 ]]
then
	echo "Failed to mount /home/${CRYPT_USER}"
	exit 1
fi

mount -i -t ecryptfs -o ecryptfs_passthrough=no,ecryptfs_unlink_sigs,ecryptfs_cipher=aes,ecryptfs_key_bytes=16,ecryptfs_sig=$sig1,ecryptfs_fnek_sig=$sig2 $DIR/.Private $DIR

if [[ "$?" != 0 ]]
then
	echo "Failed to mount /home/${CRYPT_USER}"
	exit 1
fi

echo "/home/${CRYPT_USER} mounted"

echo
